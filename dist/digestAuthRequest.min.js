!function(e,t){"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t(require,exports,module):e.digestAuthRequest=t()}(this,function(e,t,s){return function(s,i,n,u){var a=this;if(void 0===window.CryptoJS&&void 0===o&&"function"==typeof e)var o=e("crypto-js");void 0!==window.CryptoJS&&(o=window.CryptoJS);this.scheme=null,this.nonce=null,this.realm=null,this.qop=null,this.response=null,this.opaque=null,this.nc=1,this.cnonce=null,this.timeout=1e4,this.loggingOn=!0,this.post=!1,"post"!==s.toLowerCase()&&"put"!==s.toLowerCase()||(this.post=!0),this.request=function(e,t,s){s&&(a.data=JSON.stringify(s)),a.successFn=e,a.errorFn=t,a.nonce?a.makeAuthenticatedRequest():a.makeUnauthenticatedRequest(a.data)},this.makeUnauthenticatedRequest=function(e){a.firstRequest=new XMLHttpRequest,a.firstRequest.open(s,i,!0),a.firstRequest.timeout=a.timeout,a.post&&a.firstRequest.setRequestHeader("Content-type","application/json"),a.firstRequest.onreadystatechange=function(){if(2===a.firstRequest.readyState){var e,t=a.firstRequest.getAllResponseHeaders();t=t.split("\n");for(var s=0;s<t.length;s++)null!=t[s].match(/www-authenticate/i)&&(e=t[s]);if(null!=e){for(e=(e=e.slice(e.indexOf(":")+1,-1)).split(","),a.scheme=e[0].split(/\s/)[1],s=0;s<e.length;s++){var n=e[s].indexOf("="),u=e[s].substring(0,n),o=e[s].substring(n+1);o=o.replace(/['"]+/g,""),null!=u.match(/realm/i)&&(a.realm=o),null!=u.match(/nonce/i)&&(a.nonce=o),null!=u.match(/opaque/i)&&(a.opaque=o),null!=u.match(/qop/i)&&(a.qop=o)}a.cnonce=a.generateCnonce(),a.nc++,a.log("received headers:"),a.log("\trealm: "+a.realm),a.log("\tnonce: "+a.nonce),a.log("\topaque: "+a.opaque),a.log("\tqop: "+a.qop),a.makeAuthenticatedRequest()}}4===a.firstRequest.readyState&&200===a.firstRequest.status&&(a.log("Authentication not required for "+i),"undefined"!==a.firstRequest.responseText?0<a.firstRequest.responseText.length&&(a.isJson(a.firstRequest.responseText)?a.successFn(JSON.parse(a.firstRequest.responseText)):a.successFn(a.firstRequest.responseText)):a.successFn())},a.post?a.firstRequest.send(a.data):a.firstRequest.send(),a.log("Unauthenticated request to "+i),a.firstRequest.onerror=function(){401!==a.firstRequest.status&&(a.log("Error ("+a.firstRequest.status+") on unauthenticated request to "+i),a.errorFn(a.firstRequest.status))}},this.makeAuthenticatedRequest=function(){a.response=a.formulateResponse(),a.authenticatedRequest=new XMLHttpRequest,a.authenticatedRequest.open(s,i,!0),a.authenticatedRequest.timeout=a.timeout;var e=a.scheme+' username="'+n+'", realm="'+a.realm+'", nonce="'+a.nonce+'", uri="'+i+'", response="'+a.response+'", opaque="'+a.opaque+'", qop='+a.qop+", nc="+("00000000"+a.nc).slice(-8)+', cnonce="'+a.cnonce+'"';a.authenticatedRequest.setRequestHeader("Authorization",e),a.log("digest auth header response to be sent:"),a.log(e),a.post&&a.authenticatedRequest.setRequestHeader("Content-type","application/json"),a.authenticatedRequest.onload=function(){200<=a.authenticatedRequest.status&&a.authenticatedRequest.status<400?(a.nc++,"undefined"!==a.authenticatedRequest.responseText&&0<a.authenticatedRequest.responseText.length?a.isJson(a.authenticatedRequest.responseText)?a.successFn(JSON.parse(a.authenticatedRequest.responseText)):a.successFn(a.authenticatedRequest.responseText):a.successFn()):(a.nonce=null,a.errorFn(a.authenticatedRequest.status))},a.authenticatedRequest.onerror=function(){a.log("Error ("+a.authenticatedRequest.status+") on authenticated request to "+i),a.nonce=null,a.errorFn(a.authenticatedRequest.status)},a.post?a.authenticatedRequest.send(a.data):a.authenticatedRequest.send(),a.log("Authenticated request to "+i)},this.formulateResponse=function(){var e=o.MD5(n+":"+a.realm+":"+u).toString(),t=o.MD5(s+":"+i).toString();return o.MD5(e+":"+a.nonce+":"+("00000000"+a.nc).slice(-8)+":"+a.cnonce+":"+a.qop+":"+t).toString()},this.generateCnonce=function(){for(var e="abcdef0123456789",t="",s=0;s<16;s++){var n=Math.round(Math.random()*e.length);t+=e.substr(n,1)}return t},this.abort=function(){a.log("[digestAuthRequest] Aborted request to "+i),null!=a.firstRequest&&4!=a.firstRequest.readyState&&a.firstRequest.abort(),null!=a.authenticatedRequest&&4!=a.authenticatedRequest.readyState&&a.authenticatedRequest.abort()},this.isJson=function(e){try{JSON.parse(e)}catch(e){return!1}return!0},this.log=function(e){a.loggingOn&&console.log("[digestAuthRequest] "+e)},this.version=function(){return"0.8.0"}}});